# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  azureSubscription: '$(AZURE_SUBSCRIPTION)'
  repository: '_$(Build.Repository.Name)'
  storage: '$(CONTAINER_NAME)'

stages:
  # Build Stage
  - stage: BuildAndTest
    jobs:
      - job: BuildAndTest
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '14.x'
          displayName: 'Install Node.js'

        - script: |
            npm install
            npm run build
          displayName: 'npm install and build'

        - task: CopyFiles@2
          displayName: 'copy files to: $(Build.ArtifactStagingDirectory)'
          inputs:
            SourceFolder: '$(System.DefaultWorkingDirectory)/build'
            TargetFolder: '$(Build.ArtifactStagingDirectory)'

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact: drop'
          inputs:
            PathtoPublish: '$(build.ArtifactStagingDirectory)'

        - task: AzureFileCopy@2
          displayName: 'AzureBlob File Copy'
          inputs:
            SourcePath: '$(System.DefaultWorkingDirectory)/$(repository)/drop'
            connectedServiceNameARM: '$(azureSubscription)'
            Destination: AzureBlob
            storage: '$(storage)'
            ContainerName: '$web'
            BlobPrefix: '$(Build.SourceVersion)'
          